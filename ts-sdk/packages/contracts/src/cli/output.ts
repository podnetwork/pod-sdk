import * as fs from "node:fs";
import * as path from "node:path";
import type { ExtractedAbi } from "./extract.js";

/**
 * Convert contract name to camelCase export name
 *
 * @example
 * "MyContract" -> "myContractAbi"
 * "ERC20Token" -> "erc20TokenAbi"
 */
export function toAbiExportName(contractName: string): string {
  // Handle edge cases
  if (contractName.length === 0) {
    return "abi";
  }

  // Convert to camelCase: first char lowercase, rest unchanged
  const camelCase = contractName.charAt(0).toLowerCase() + contractName.slice(1);

  return `${camelCase}Abi`;
}

/**
 * Convert contract name to file name (kebab-case)
 *
 * @example
 * "MyContract" -> "myContract"
 * "ERC20Token" -> "erc20Token"
 */
export function toFileName(contractName: string): string {
  // Use camelCase for file names to match export names
  if (contractName.length === 0) {
    return "contract";
  }

  return contractName.charAt(0).toLowerCase() + contractName.slice(1);
}

/**
 * Generate TypeScript file content for an ABI
 */
export function generateAbiFile(extracted: ExtractedAbi): string {
  const exportName = toAbiExportName(extracted.contractName);
  const abiJson = JSON.stringify(extracted.abi, null, 2);

  // Indent the ABI content to match export format
  const indentedAbi = abiJson.split("\n").join("\n");

  return `/**
 * ABI for ${extracted.contractName}
 *
 * Extracted from: ${extracted.sourceFile}
 * Generated by: @podnetwork/contracts extract-abi
 */
export const ${exportName} = ${indentedAbi} as const;
`;
}

/**
 * Write extracted ABI to a TypeScript file
 *
 * @param extracted - Extracted ABI data
 * @param outputDir - Output directory
 * @param existingNames - Set of already used file names (for collision handling)
 * @returns The file path that was written
 */
export function writeAbiFile(
  extracted: ExtractedAbi,
  outputDir: string,
  existingNames = new Set<string>()
): string {
  // Ensure output directory exists
  fs.mkdirSync(outputDir, { recursive: true });

  // Determine file name, handling collisions
  const baseName = toFileName(extracted.contractName);
  let fileName = baseName;
  let counter = 1;

  while (existingNames.has(fileName)) {
    fileName = `${baseName}_${String(counter)}`;
    counter++;
  }
  existingNames.add(fileName);

  const filePath = path.join(outputDir, `${fileName}.ts`);
  const content = generateAbiFile(extracted);

  fs.writeFileSync(filePath, content, "utf-8");

  return filePath;
}

/**
 * Generate barrel file (index.ts) with re-exports
 *
 * @param fileNames - List of file names (without extension) to export
 * @returns Content of the barrel file
 */
export function generateBarrelFile(fileNames: string[]): string {
  if (fileNames.length === 0) {
    return `/**
 * ABI Barrel Export
 *
 * Generated by: @podnetwork/contracts extract-abi
 */

// No ABIs generated
`;
  }

  const exports = fileNames.map((name) => `export * from "./${name}.js";`).join("\n");

  return `/**
 * ABI Barrel Export
 *
 * Generated by: @podnetwork/contracts extract-abi
 */
${exports}
`;
}

/**
 * Write barrel file to output directory
 */
export function writeBarrelFile(outputDir: string, fileNames: string[]): void {
  const content = generateBarrelFile(fileNames);
  const filePath = path.join(outputDir, "index.ts");
  fs.writeFileSync(filePath, content, "utf-8");
}
